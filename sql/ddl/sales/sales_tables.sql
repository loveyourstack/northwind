
CREATE TABLE sales.customer
(
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  address text_medium,
  city text_medium,
  code char(5) NOT NULL UNIQUE CHECK (code ~ '^[A-Z]+$'),
  company_name text_medium_mandatory,
  contact_name text_medium_mandatory,
  contact_title text_medium,
  country_fk bigint NOT NULL REFERENCES core.country (id),
  created_at tracking_at,
  created_by tracking_by,
  last_user_update_by tracking_by,
  phone text_short,
  postal_code text_short,
  state text_short,
  updated_at tracking_at
);
COMMENT ON TABLE sales.customer IS 'shortname: c';


CREATE TABLE sales.shipper
(
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  company_name text_medium_mandatory UNIQUE,
  created_at tracking_at,
  created_by tracking_by,
  last_user_update_by tracking_by,
  phone text_short,
  updated_at tracking_at
);
COMMENT ON TABLE sales.shipper IS 'shortname: ship';


CREATE TABLE sales.order
(
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at tracking_at,
  created_by tracking_by,
  customer_fk bigint NOT NULL REFERENCES sales.customer(id),
  dest_address text_medium_mandatory,
  dest_city text_medium_mandatory,
  dest_company_name text_medium_mandatory,
  dest_country_fk bigint NOT NULL REFERENCES core.country(id),
  dest_postal_code text_short,
  dest_state text_short,
  freight_cost price_gte0,
  is_shipped boolean NOT NULL DEFAULT false,
  last_user_update_by tracking_by,
  order_date date NOT NULL CHECK (order_date >= '2010-01-01'),
  order_number int_positive UNIQUE,
  required_date date NOT NULL CHECK (required_date >= '2010-01-01'),
  salesman_fk bigint NOT NULL REFERENCES hr.employee(id),
  shipper_fk bigint NOT NULL REFERENCES sales.shipper(id),
  shipped_date date NOT NULL DEFAULT '0001-01-01'::date,
  updated_at tracking_at
);
COMMENT ON TABLE sales.order IS 'shortname: o';
--- change columns with ---
CREATE TABLE sales.order_archived 
( 
  LIKE sales.order,
  archived_at tracking_at,
  archived_by_cascade bool NOT NULL
);
COMMENT ON TABLE sales.order_archived IS 'shortname: o_arc';


CREATE TABLE sales.order_item
(
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at tracking_at,
  created_by tracking_by,
  discount numeric(5,4) NOT NULL CHECK (discount BETWEEN 0.0 AND 1.0),
  gross_value numeric(14,4) NOT NULL GENERATED ALWAYS AS (quantity * unit_price * (1 - discount)) STORED,
  last_user_update_by tracking_by,
  order_fk bigint NOT NULL REFERENCES sales.order(id),
  product_fk bigint NOT NULL REFERENCES core.product(id),
  quantity int_positive,
  unit_price price_gte0,
  updated_at tracking_at,
  UNIQUE(order_fk, product_fk)
);
COMMENT ON TABLE sales.order_item IS 'shortname: oi';
--- change columns with ---
CREATE TABLE sales.order_item_archived
( 
  LIKE sales.order_item,
  archived_at tracking_at,
  archived_by_cascade bool NOT NULL
);
COMMENT ON TABLE sales.order_item_archived IS 'shortname: oi_arc';

CREATE INDEX order_item_order_fk_idx ON sales.order_item USING btree(order_fk);
CLUSTER sales.order_item USING order_item_order_fk_idx;


CREATE TABLE sales.territory
(
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  code char(5) NOT NULL UNIQUE CHECK (code ~ '^[0-9]+$'),
  created_at tracking_at,
  created_by tracking_by,
  last_user_update_by tracking_by,
  name text_medium_mandatory UNIQUE,
  region sales.region NOT NULL,
  salesman_fk bigint NOT NULL REFERENCES hr.employee(id),
  updated_at tracking_at
);
COMMENT ON TABLE sales.territory IS 'shortname: terr';
